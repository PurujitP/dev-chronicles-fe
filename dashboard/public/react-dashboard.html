<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#4F46E5" />
    <meta name="description" content="DevChronicles - Track your developer learning journey" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <title>DevChronicles - React Dashboard</title>
    
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      /* CSS Variables */
      :root {
          --primary-color: #4F46E5;
          --primary-hover: #4338CA;
          --secondary-color: #6B7280;
          --success-color: #10B981;
          --warning-color: #F59E0B;
          --error-color: #EF4444;
          --text-primary: #111827;
          --text-secondary: #6B7280;
          --text-tertiary: #9CA3AF;
          --bg-primary: #FFFFFF;
          --bg-secondary: #F9FAFB;
          --bg-tertiary: #F3F4F6;
          --border-color: #E5E7EB;
          --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
          --radius-sm: 0.375rem;
          --radius-md: 0.5rem;
          --radius-lg: 0.75rem;
          --spacing-xs: 0.25rem;
          --spacing-sm: 0.5rem;
          --spacing-md: 1rem;
          --spacing-lg: 1.5rem;
          --spacing-xl: 2rem;
          --spacing-2xl: 3rem;
      }

      /* Reset and Base Styles */
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background-color: var(--bg-secondary);
          color: var(--text-primary);
          line-height: 1.6;
          font-size: 14px;
          min-height: 100vh;
      }

      /* Header Styles */
      .header {
          background-color: var(--bg-primary);
          border-bottom: 1px solid var(--border-color);
          padding: 0 var(--spacing-lg);
          position: sticky;
          top: 0;
          z-index: 100;
      }

      .header-container {
          max-width: 1400px;
          margin: 0 auto;
          display: flex;
          align-items: center;
          justify-content: space-between;
          height: 64px;
      }

      .header-left {
          display: flex;
          align-items: center;
          gap: var(--spacing-2xl);
      }

      .logo {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
          font-weight: 600;
          font-size: 18px;
          color: var(--primary-color);
      }

      .logo i {
          font-size: 20px;
      }

      .nav {
          display: flex;
          gap: var(--spacing-lg);
      }

      .nav-link {
          text-decoration: none;
          color: var(--text-secondary);
          font-weight: 500;
          padding: var(--spacing-sm) var(--spacing-md);
          border-radius: var(--radius-sm);
          transition: all 0.2s ease;
      }

      .nav-link:hover,
      .nav-link.active {
          color: var(--primary-color);
          background-color: rgba(79, 70, 229, 0.1);
      }

      .header-right {
          display: flex;
          align-items: center;
          gap: var(--spacing-lg);
      }

      .search-box {
          position: relative;
          display: flex;
          align-items: center;
      }

      .search-box i {
          position: absolute;
          left: 12px;
          color: var(--text-tertiary);
          font-size: 14px;
      }

      .search-box input {
          padding: 8px 12px 8px 36px;
          border: 1px solid var(--border-color);
          border-radius: var(--radius-md);
          font-size: 14px;
          width: 300px;
          transition: border-color 0.2s ease;
      }

      .search-box input:focus {
          outline: none;
          border-color: var(--primary-color);
      }

      .user-profile {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
          cursor: pointer;
          padding: var(--spacing-sm);
          border-radius: var(--radius-sm);
          transition: background-color 0.2s ease;
      }

      .user-profile:hover {
          background-color: var(--bg-tertiary);
      }

      .profile-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
      }

      .user-name {
          font-weight: 500;
          color: var(--text-primary);
      }

      /* Main Content */
      .main-content {
          flex: 1;
          padding: var(--spacing-xl) var(--spacing-lg);
      }

      .container {
          max-width: 1400px;
          margin: 0 auto;
      }

      /* Page Header */
      .page-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: var(--spacing-2xl);
      }

      .page-title h1 {
          font-size: 28px;
          font-weight: 700;
          color: var(--text-primary);
          margin-bottom: var(--spacing-xs);
      }

      .page-title p {
          color: var(--text-secondary);
          font-size: 16px;
      }

      .page-actions {
          display: flex;
          gap: var(--spacing-md);
      }

      /* Login Prompt */
      .login-prompt {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          font-size: 14px;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      /* Buttons */
      .btn {
          display: inline-flex;
          align-items: center;
          gap: var(--spacing-sm);
          padding: 10px 20px;
          border: none;
          border-radius: var(--radius-md);
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          text-decoration: none;
      }

      .btn-primary {
          background-color: var(--primary-color);
          color: white;
      }

      .btn-primary:hover {
          background-color: var(--primary-hover);
      }

      .btn-secondary {
          background-color: var(--bg-tertiary);
          color: var(--text-primary);
          border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
          background-color: var(--border-color);
      }

      .btn-icon {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 32px;
          height: 32px;
          border: none;
          border-radius: var(--radius-sm);
          background-color: transparent;
          color: var(--text-secondary);
          cursor: pointer;
          transition: all 0.2s ease;
      }

      .btn-icon:hover {
          background-color: var(--bg-tertiary);
          color: var(--text-primary);
      }

      /* Metrics Grid */
      .metrics-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: var(--spacing-lg);
          margin-bottom: var(--spacing-2xl);
      }

      .metric-card {
          background: var(--bg-primary);
          border-radius: var(--radius-lg);
          padding: var(--spacing-lg);
          box-shadow: var(--shadow-sm);
          border: 1px solid var(--border-color);
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: var(--spacing-md);
      }

      .metric-card:hover {
          box-shadow: var(--shadow-md);
          transform: translateY(-1px);
      }

      .metric-icon {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 48px;
          height: 48px;
          border-radius: var(--radius-md);
          flex-shrink: 0;
      }

      .titles-icon {
          background-color: rgba(99, 102, 241, 0.1);
          color: #6366F1;
      }

      .concept-icon {
          background-color: rgba(16, 185, 129, 0.1);
          color: var(--success-color);
      }

      .time-icon {
          background-color: rgba(245, 158, 11, 0.1);
          color: var(--warning-color);
      }

      .entries-icon {
          background-color: rgba(239, 68, 68, 0.1);
          color: var(--error-color);
      }

      .metric-content {
          flex: 1;
      }

      .metric-value {
          font-size: 24px;
          font-weight: 700;
          color: var(--text-primary);
          line-height: 1.2;
      }

      .metric-label {
          font-size: 14px;
          color: var(--text-secondary);
          margin-bottom: var(--spacing-xs);
      }

      .metric-change {
          display: flex;
          align-items: center;
          gap: 4px;
          font-size: 12px;
          color: var(--success-color);
      }

      .percentage.negative {
          color: var(--error-color);
      }

      .percentage.neutral {
          color: var(--text-secondary);
      }

      /* Dashboard Grid */
      .dashboard-grid {
          display: grid;
          grid-template-columns: 2fr 1fr;
          grid-template-rows: auto auto;
          gap: var(--spacing-lg);
      }

      .activity-card {
          grid-row: span 2;
      }

      /* Dashboard Cards */
      .dashboard-card {
          background: var(--bg-primary);
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-sm);
          border: 1px solid var(--border-color);
          overflow: hidden;
      }

      .card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: var(--spacing-lg);
          border-bottom: 1px solid var(--border-color);
      }

      .card-header h3 {
          font-size: 18px;
          font-weight: 600;
          color: var(--text-primary);
      }

      .card-actions {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
      }

      .time-filter {
          border: 1px solid var(--border-color);
          border-radius: var(--radius-sm);
          padding: 4px 8px;
          font-size: 12px;
          background: var(--bg-primary);
          color: var(--text-primary);
      }

      .card-content {
          padding: var(--spacing-lg);
      }

      /* Activity List */
      .activity-list {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-md);
      }

      .activity-item {
          display: flex;
          align-items: center;
          gap: var(--spacing-md);
          padding: var(--spacing-md);
          border-radius: var(--radius-md);
          transition: all 0.2s ease;
          cursor: pointer;
      }

      .activity-item:hover {
          background-color: var(--bg-secondary);
      }

      /* Category List */
      .category-list {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-md);
      }

      .category-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: var(--spacing-sm) 0;
      }

      .category-info {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
      }

      .category-color {
          width: 12px;
          height: 12px;
          border-radius: 50%;
      }

      .category-color.titles {
          background-color: #6366F1;
      }

      .category-color.learning {
          background-color: var(--success-color);
      }

      .category-color.docs {
          background-color: var(--warning-color);
      }

      .category-color.tools {
          background-color: var(--error-color);
      }

      .category-name {
          font-weight: 500;
          color: var(--text-primary);
          text-transform: capitalize;
      }

      .category-stats {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
      }

      .category-count {
          font-weight: 600;
          color: var(--text-primary);
      }

      .category-change {
          font-size: 12px;
          padding: 2px 6px;
          border-radius: var(--radius-sm);
      }

      .category-change.positive {
          background-color: rgba(16, 185, 129, 0.1);
          color: var(--success-color);
      }

      .category-change.negative {
          background-color: rgba(239, 68, 68, 0.1);
          color: var(--error-color);
      }

      /* Progress Bars */
      .progress-item {
          margin-bottom: var(--spacing-md);
      }

      .progress-label {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: var(--spacing-xs);
          font-size: 14px;
      }

      .progress-label span:first-child {
          font-weight: 500;
          color: var(--text-primary);
      }

      .progress-percent {
          font-size: 12px;
          color: var(--text-secondary);
      }

      .progress-bar {
          height: 8px;
          background-color: var(--bg-tertiary);
          border-radius: var(--radius-sm);
          overflow: hidden;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-hover) 100%);
          transition: width 0.3s ease;
      }

      /* Action Buttons */
      .action-buttons {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-sm);
      }

      .action-btn {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
          padding: var(--spacing-md);
          border: none;
          border-radius: var(--radius-md);
          background-color: var(--bg-secondary);
          color: var(--text-primary);
          cursor: pointer;
          transition: all 0.2s ease;
          font-size: 14px;
      }

      .action-btn:hover {
          background-color: var(--bg-tertiary);
          transform: translateX(4px);
      }

      .action-btn i {
          color: var(--primary-color);
      }

      .activity-icon {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 36px;
          height: 36px;
          border-radius: var(--radius-sm);
          flex-shrink: 0;
      }

      .activity-icon.titles {
          background-color: rgba(99, 102, 241, 0.1);
          color: #6366F1;
      }

      .activity-icon.learning {
          background-color: rgba(16, 185, 129, 0.1);
          color: var(--success-color);
      }

      .activity-icon.docs {
          background-color: rgba(245, 158, 11, 0.1);
          color: var(--warning-color);
      }

      .activity-icon.tools {
          background-color: rgba(239, 68, 68, 0.1);
          color: var(--error-color);
      }

      .activity-content {
          flex: 1;
          min-width: 0;
      }

      .activity-title {
          font-weight: 500;
          color: var(--text-primary);
          font-size: 14px;
          margin-bottom: 4px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
      }

      .activity-meta {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
          font-size: 12px;
          color: var(--text-secondary);
      }

      .activity-time {
          color: var(--text-tertiary);
      }

      /* Loading Overlay */
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(255, 255, 255, 0.9);
          backdrop-filter: blur(4px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
      }

      .loading-spinner {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: var(--spacing-md);
      }

      .loading-spinner i {
          font-size: 24px;
          color: var(--primary-color);
      }

      .loading-spinner span {
          font-weight: 500;
          color: var(--text-secondary);
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
          .dashboard-grid {
              grid-template-columns: 1fr;
              grid-template-rows: auto;
          }
          
          .activity-card {
              grid-row: auto;
          }
      }

      @media (max-width: 768px) {
          .header-container {
              flex-direction: column;
              height: auto;
              gap: var(--spacing-md);
              padding: var(--spacing-md) 0;
          }
          
          .header-left {
              flex-direction: column;
              gap: var(--spacing-md);
              width: 100%;
          }
          
          .nav {
              justify-content: center;
          }
          
          .search-box input {
              width: 200px;
          }
          
          .page-header {
              flex-direction: column;
              gap: var(--spacing-md);
          }
          
          .metrics-grid {
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          }
          
          .main-content {
              padding: var(--spacing-lg) var(--spacing-md);
          }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;

      const Dashboard = () => {
        // State management
        const [isLoading, setIsLoading] = useState(true);
        const [userData, setUserData] = useState({ name: 'User', email: 'user@example.com' });
        const [stats, setStats] = useState(null);
        const [recentActivity, setRecentActivity] = useState(null);
        const [categoryData, setCategoryData] = useState(null);
        const [accessToken, setAccessToken] = useState(null);
        const [searchQuery, setSearchQuery] = useState('');
        const [filteredActivity, setFilteredActivity] = useState(null);

        const apiBaseUrl = 'http://localhost:8000/backend-api';

        // Load user data from various sources
        const loadUserData = useCallback(async () => {
          try {
            console.log('Loading user data from various sources...');
            
            // Try Chrome extension storage first
            if (typeof chrome !== 'undefined' && chrome.storage) {
              console.log('Chrome extension API detected, checking storage...');
              
              const result = await new Promise((resolve) => {
                chrome.storage.local.get(['user_data', 'access_token'], (result) => {
                  console.log('Extension storage result:', result);
                  resolve(result);
                });
              });
              
              if (result.access_token && result.user_data) {
                console.log('Found token in extension storage!');
                setUserData(result.user_data);
                setAccessToken(result.access_token);
                
                // Store in localStorage for backup
                localStorage.setItem('devchronicles_token', result.access_token);
                localStorage.setItem('devchronicles_user', JSON.stringify(result.user_data));
                
                return;
              }
            }
            
            // Check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token') || urlParams.get('auth_token');
            const userFromUrl = urlParams.get('user');
            
            if (tokenFromUrl && userFromUrl) {
              console.log('Found token in URL parameters!');
              setAccessToken(tokenFromUrl);
              setUserData(JSON.parse(decodeURIComponent(userFromUrl)));
              
              // Store in localStorage for future use
              localStorage.setItem('devchronicles_token', tokenFromUrl);
              localStorage.setItem('devchronicles_user', userFromUrl);
              
              // Clean up URL
              window.history.replaceState({}, document.title, window.location.pathname);
              return;
            }
            
            // Check localStorage
            const storedToken = localStorage.getItem('devchronicles_token');
            const storedUser = localStorage.getItem('devchronicles_user');
            
            if (storedToken && storedUser) {
              console.log('Found token in localStorage!');
              setAccessToken(storedToken);
              setUserData(JSON.parse(storedUser));
              return;
            }
            
            // Default user info (no authentication)
            console.log('No authentication found, using default user');
            setUserData({ name: 'User', email: 'user@example.com' });
            
          } catch (error) {
            console.error('Error loading user data:', error);
            setUserData({ name: 'User', email: 'user@example.com' });
          }
        }, []);

        // Load stats
        const loadStats = useCallback(async () => {
          try {
            console.log('Loading stats...');
            const headers = {
              'Content-Type': 'application/json'
            };
            
            if (accessToken) {
              headers['Authorization'] = `Bearer ${accessToken}`;
            }
            
            const response = await fetch(`${apiBaseUrl}/chrome/stats`, {
              method: 'GET',
              headers: headers
            });
            
            if (response.ok) {
              const data = await response.json();
              setStats(data);
            } else {
              console.log('Failed to load stats, using sample data. Status:', response.status);
              setStats({
                titlesExplored: 12,
                conceptsLearned: 8,
                timeSpent: '24h',
                totalEntries: 156
              });
            }
          } catch (error) {
            console.error('Error loading stats:', error);
            setStats({
              titlesExplored: 12,
              conceptsLearned: 8,
              timeSpent: '24h',
              totalEntries: 156
            });
          }
        }, [accessToken, apiBaseUrl]);

        // Load recent activity
        const loadRecentActivity = useCallback(async () => {
          try {
            console.log('Loading recent activity...');
            const headers = {
              'Content-Type': 'application/json'
            };
            
            if (accessToken) {
              headers['Authorization'] = `Bearer ${accessToken}`;
            }
            
            const response = await fetch(`${apiBaseUrl}/chrome/recent-activity`, {
              method: 'GET',
              headers: headers
            });
            
            if (response.ok) {
              const data = await response.json();
              setRecentActivity(data);
            } else {
              console.log('Failed to load activity, using sample data. Status:', response.status);
              setRecentActivity(getSampleActivity());
            }
          } catch (error) {
            console.error('Error loading recent activity:', error);
            setRecentActivity(getSampleActivity());
          }
        }, [accessToken, apiBaseUrl]);

        // Load category data
        const loadCategoryData = useCallback(async (days = 7) => {
          try {
            console.log(`Loading category data for ${days} days...`);
            const headers = {
              'Content-Type': 'application/json'
            };
            
            if (accessToken) {
              headers['Authorization'] = `Bearer ${accessToken}`;
            }
            
            const response = await fetch(`${apiBaseUrl}/chrome/category-wise-breakdown?days=${days}`, {
              method: 'GET',
              headers: headers
            });
            
            if (response.ok) {
              const data = await response.json();
              setCategoryData(data);
            } else {
              console.log('Failed to load category data, using sample data. Status:', response.status);
              setCategoryData(getSampleCategoryData());
            }
          } catch (error) {
            console.error('Error loading category data:', error);
            setCategoryData(getSampleCategoryData());
          }
        }, [accessToken, apiBaseUrl]);

        // Get sample activity data
        const getSampleActivity = () => {
          return [
            {
              id: 1,
              title: 'How to fix React useState hook errors',
              url: 'https://stackoverflow.com/questions/react-usestate',
              category: 'titles',
              timestamp: new Date(Date.now() - 1000 * 60 * 30),
              domain: 'stackoverflow.com'
            },
            {
              id: 2,
              title: 'Python async/await tutorial',
              url: 'https://realpython.com/async-io-python/',
              category: 'learning',
              timestamp: new Date(Date.now() - 1000 * 60 * 60),
              domain: 'realpython.com'
            },
            {
              id: 3,
              title: 'Docker compose documentation',
              url: 'https://docs.docker.com/compose/',
              category: 'docs',
              timestamp: new Date(Date.now() - 1000 * 60 * 90),
              domain: 'docs.docker.com'
            }
          ];
        };

        // Get sample category data
        const getSampleCategoryData = () => {
          return {
            period: {
              days: 7,
              start_date: "2025-06-28T00:00:00Z",
              end_date: "2025-07-05T23:59:59Z"
            },
            categories: {
              "1": {
                value: 23,
                label: "data systems",
                metadata: { percentage_change: -15 }
              },
              "2": {
                value: 44,
                label: "infrastructure", 
                metadata: { percentage_change: 15 }
              },
              "3": {
                value: 33,
                label: "gen-ai",
                metadata: { percentage_change: -25 }
              },
              "4": {
                value: 42,
                label: "scaling",
                metadata: { percentage_change: 45 }
              }
            },
            total_entries: 98
          };
        };

        // Initialize dashboard
        useEffect(() => {
          const initializeDashboard = async () => {
            console.log('Initializing dashboard...');
            setIsLoading(true);
            
            try {
              await loadUserData();
            } catch (error) {
              console.error('Error initializing dashboard:', error);
            } finally {
              setIsLoading(false);
            }
          };
          
          initializeDashboard();
        }, [loadUserData]);

        // Load dashboard data when access token changes
        useEffect(() => {
          if (!isLoading) {
            const loadDashboardData = async () => {
              await Promise.all([
                loadStats(),
                loadRecentActivity(),
                loadCategoryData()
              ]);
            };
            
            loadDashboardData();
          }
        }, [isLoading, loadStats, loadRecentActivity, loadCategoryData]);

        // Handle search
        useEffect(() => {
          if (!searchQuery.trim()) {
            setFilteredActivity(recentActivity);
          } else if (recentActivity) {
            const filtered = recentActivity.filter(item =>
              item.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
              (item.domain && item.domain.toLowerCase().includes(searchQuery.toLowerCase()))
            );
            setFilteredActivity(filtered);
          }
        }, [searchQuery, recentActivity]);

        // Utility functions
        const parseMetric = (metric) => {
          if (typeof metric === 'object' && metric.value !== undefined) {
            return {
              value: metric.value,
              percentage: metric.meta_data?.percentage_increased || 0
            };
          } else {
            return {
              value: metric,
              percentage: 0
            };
          }
        };

        const formatTimeAgo = (timestamp) => {
          try {
            const now = new Date();
            const time = new Date(timestamp);
            
            if (isNaN(time.getTime())) {
              return 'Recently';
            }
            
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return time.toLocaleDateString();
          } catch (error) {
            return 'Recently';
          }
        };

        const getCategoryClass = (category) => {
          if (!category) return 'learning';
          
          const categoryLower = category.toLowerCase();
          const classMap = {
            'titles': 'titles',
            'learning': 'learning',
            'docs': 'docs',
            'tools': 'tools'
          };
          
          for (const [key, value] of Object.entries(classMap)) {
            if (categoryLower.includes(key)) {
              return value;
            }
          }
          
          return 'learning';
        };

        const getCategoryIcon = (category) => {
          if (!category) return 'fas fa-circle';
          
          const categoryLower = category.toLowerCase();
          const iconMap = {
            'titles': 'fas fa-book-open',
            'learning': 'fas fa-graduation-cap',
            'docs': 'fas fa-book',
            'tools': 'fas fa-tools'
          };
          
          for (const [key, value] of Object.entries(iconMap)) {
            if (categoryLower.includes(key)) {
              return value;
            }
          }
          
          return 'fas fa-circle';
        };

        const extractDomain = (url) => {
          if (!url) return '';
          try {
            const domain = new URL(url).hostname;
            return domain.replace('www.', '');
          } catch (e) {
            return url.split('/')[0] || '';
          }
        };

        const mapLabelToCategory = (label) => {
          if (!label) return 'learning';
          
          const labelLower = label.toLowerCase();
          const categoryMap = {
            'data systems': 'tools',
            'infrastructure': 'tools', 
            'gen-ai': 'learning',
            'scaling': 'docs',
            'programming': 'learning',
            'development': 'learning',
            'documentation': 'docs',
            'tutorial': 'learning',
            'guide': 'docs',
            'tools': 'tools',
            'learning': 'learning'
          };
          
          // Check for exact matches first
          if (categoryMap[labelLower]) {
            return categoryMap[labelLower];
          }
          
          // Check for partial matches
          for (const [key, value] of Object.entries(categoryMap)) {
            if (labelLower.includes(key)) {
              return value;
            }
          }
          
          return 'learning'; // default fallback
        };

        const handleActivityClick = (url) => {
          if (url) {
            window.open(url, '_blank');
          }
        };

        const showNotification = (message, type = 'success') => {
          alert(message); // Simple notification for now
        };

        // Render loading state
        if (isLoading) {
          return (
            <div className="loading-overlay">
              <div className="loading-spinner">
                <i className="fas fa-spinner fa-spin"></i>
                <span>Loading dashboard...</span>
              </div>
            </div>
          );
        }

        return (
          <div className="dashboard">
            {/* Header */}
            <header className="header">
              <div className="header-container">
                <div className="header-left">
                  <div className="logo">
                    <i className="fas fa-chart-line"></i>
                    <span>DevChronicles</span>
                  </div>
                  <nav className="nav">
                    <a href="#" className="nav-link active">Dashboard</a>
                    <a href="#" className="nav-link">History</a>
                    <a href="#" className="nav-link">Insights</a>
                    <a href="#" className="nav-link">Settings</a>
                  </nav>
                </div>
                <div className="header-right">
                  <div className="search-box">
                    <i className="fas fa-search"></i>
                    <input 
                      type="text" 
                      placeholder="Search your history..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                    />
                  </div>
                  <div className="user-profile">
                    <img src="https://via.placeholder.com/32x32/4F46E5/ffffff?text=U" alt="Profile" className="profile-avatar" />
                    <span className="user-name">{userData?.name || userData?.email || 'User'}</span>
                  </div>
                </div>
              </div>
            </header>

            {/* Main Content */}
            <main className="main-content">
              <div className="container">
                {/* Page Header */}
                <section className="page-header">
                  <div className="page-title">
                    <h1>React Developer Dashboard</h1>
                    <p>Track your learning journey and development insights - Now powered by React!</p>
                  </div>
                  <div className="page-actions">
                    <button className="btn btn-secondary" onClick={() => showNotification('Sync functionality!')}>
                      <i className="fas fa-sync"></i>
                      Sync Data
                    </button>
                    <button className="btn btn-primary" onClick={() => showNotification('Export functionality!')}>
                      <i className="fas fa-download"></i>
                      Export Report
                    </button>
                  </div>
                </section>

                {/* Login Prompt */}
                {!accessToken && (
                  <div className="login-prompt">
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                      <i className="fas fa-info-circle"></i>
                      <span>For real data, use the <strong>DevChronicles Chrome Extension</strong> and click "View Full Dashboard"</span>
                    </div>
                  </div>
                )}

                {/* Metrics Cards */}
                <section className="metrics-grid">
                  <div className="metric-card">
                    <div className="metric-icon titles-icon">
                      <i className="fas fa-book-open"></i>
                    </div>
                    <div className="metric-content">
                      <div className="metric-value">
                        {stats ? parseMetric(stats.titlesExplored).value || 0 : 0}
                      </div>
                      <div className="metric-label">Titles Explored</div>
                      <div className="metric-change">
                        <i className="fas fa-arrow-up"></i>
                        <span className="percentage">
                          {stats ? parseMetric(stats.titlesExplored).percentage : 0}%
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="metric-card">
                    <div className="metric-icon concept-icon">
                      <i className="fas fa-lightbulb"></i>
                    </div>
                    <div className="metric-content">
                      <div className="metric-value">
                        {stats ? parseMetric(stats.conceptsLearned).value || 0 : 0}
                      </div>
                      <div className="metric-label">Concepts Learned</div>
                      <div className="metric-change">
                        <i className="fas fa-arrow-up"></i>
                        <span className="percentage">
                          {stats ? parseMetric(stats.conceptsLearned).percentage : 0}%
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="metric-card">
                    <div className="metric-icon time-icon">
                      <i className="fas fa-clock"></i>
                    </div>
                    <div className="metric-content">
                      <div className="metric-value">
                        {stats ? parseMetric(stats.timeSpent).value || '0h' : '0h'}
                      </div>
                      <div className="metric-label">Time Spent</div>
                      <div className="metric-change">
                        <i className="fas fa-minus"></i>
                        <span className="percentage">
                          {stats ? parseMetric(stats.timeSpent).percentage : 0}%
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="metric-card">
                    <div className="metric-icon entries-icon">
                      <i className="fas fa-database"></i>
                    </div>
                    <div className="metric-content">
                      <div className="metric-value">
                        {stats ? parseMetric(stats.totalEntries).value || 0 : 0}
                      </div>
                      <div className="metric-label">Total Entries</div>
                      <div className="metric-change">
                        <i className="fas fa-arrow-up"></i>
                        <span className="percentage">
                          {stats ? parseMetric(stats.totalEntries).percentage : 0}%
                        </span>
                      </div>
                    </div>
                  </div>
                </section>

                {/* Dashboard Content Grid */}
                <section className="dashboard-grid">
                  {/* Activity Feed */}
                  <div className="dashboard-card activity-card">
                    <div className="card-header">
                      <h3>Recent Activity</h3>
                      <div className="card-actions">
                        <button className="btn-icon" onClick={loadRecentActivity}>
                          <i className="fas fa-refresh"></i>
                        </button>
                        <button className="btn-icon">
                          <i className="fas fa-ellipsis-h"></i>
                        </button>
                      </div>
                    </div>
                    <div className="card-content">
                      <div className="activity-list">
                        {!filteredActivity || filteredActivity.length === 0 ? (
                          <p style={{ textAlign: 'center', color: 'var(--text-secondary)', padding: '2rem' }}>
                            {searchQuery ? 'No matching activities found.' : 'No recent activity found.'}
                          </p>
                        ) : (
                          filteredActivity.slice(0, 10).map((item) => {
                            const timestamp = item.timestamp || item.created_at || item.date || new Date();
                            const category = item.category || item.main_category || item.type || 'learning';
                            const domain = item.domain || extractDomain(item.url || item.link || '');
                            const url = item.url || item.link || '';

                            return (
                              <div 
                                key={item.id} 
                                className="activity-item"
                                onClick={() => handleActivityClick(url)}
                              >
                                <div className={`activity-icon ${getCategoryClass(category)}`}>
                                  <i className={getCategoryIcon(category)}></i>
                                </div>
                                <div className="activity-content">
                                  <div className="activity-title" title={item.title || 'Untitled'}>
                                    {item.title || 'Untitled'}
                                  </div>
                                  <div className="activity-meta">
                                    <span>{domain || 'Unknown source'}</span>
                                    <span className="activity-time">{formatTimeAgo(timestamp)}</span>
                                  </div>
                                </div>
                              </div>
                            );
                          })
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Category Breakdown */}
                  <div className="dashboard-card category-card">
                    <div className="card-header">
                      <h3>Category Breakdown</h3>
                      <div className="card-actions">
                        <select 
                          className="time-filter" 
                          onChange={(e) => loadCategoryData(e.target.value)}
                          defaultValue="7"
                        >
                          <option value="7">Last 7 days</option>
                          <option value="30">Last 30 days</option>
                          <option value="90">Last 3 months</option>
                        </select>
                      </div>
                    </div>
                    <div className="card-content">
                      <div className="category-list">
                        {!categoryData || !categoryData.categories ? (
                          <p style={{ textAlign: 'center', color: 'var(--text-secondary)', padding: '2rem' }}>
                            No category data available.
                          </p>
                        ) : (
                          Object.entries(categoryData.categories)
                            .map(([key, cat]) => ({
                              id: key,
                              name: cat.label,
                              value: cat.value,
                              percentage_change: cat.metadata?.percentage_change || 0,
                              category: mapLabelToCategory(cat.label)
                            }))
                            .sort((a, b) => b.value - a.value)
                            .map((cat) => (
                              <div key={cat.id} className="category-item">
                                <div className="category-info">
                                  <div className={`category-color ${cat.category}`}></div>
                                  <span className="category-name">{cat.name}</span>
                                </div>
                                <div className="category-stats">
                                  <div className="category-count">{cat.value}</div>
                                  <div className={`category-change ${cat.percentage_change >= 0 ? 'positive' : 'negative'}`}>
                                    {cat.percentage_change >= 0 ? '+' : ''}{cat.percentage_change}%
                                  </div>
                                </div>
                              </div>
                            ))
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Learning Progress */}
                  <div className="dashboard-card progress-card">
                    <div className="card-header">
                      <h3>Learning Progress</h3>
                      <div className="card-actions">
                        <button className="btn-icon">
                          <i className="fas fa-chart-line"></i>
                        </button>
                      </div>
                    </div>
                    <div className="card-content">
                      <div className="progress-item">
                        <div className="progress-label">
                          <span>JavaScript</span>
                          <span className="progress-percent">75%</span>
                        </div>
                        <div className="progress-bar">
                          <div className="progress-fill" style={{ width: '75%' }}></div>
                        </div>
                      </div>
                      <div className="progress-item">
                        <div className="progress-label">
                          <span>Python</span>
                          <span className="progress-percent">65%</span>
                        </div>
                        <div className="progress-bar">
                          <div className="progress-fill" style={{ width: '65%' }}></div>
                        </div>
                      </div>
                      <div className="progress-item">
                        <div className="progress-label">
                          <span>React</span>
                          <span className="progress-percent">40%</span>
                        </div>
                        <div className="progress-bar">
                          <div className="progress-fill" style={{ width: '40%' }}></div>
                        </div>
                      </div>
                      <div className="progress-item">
                        <div className="progress-label">
                          <span>DevOps</span>
                          <span className="progress-percent">30%</span>
                        </div>
                        <div className="progress-bar">
                          <div className="progress-fill" style={{ width: '30%' }}></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Quick Actions */}
                  <div className="dashboard-card actions-card">
                    <div className="card-header">
                      <h3>Quick Actions</h3>
                    </div>
                    <div className="card-content">
                      <div className="action-buttons">
                        <button className="action-btn" onClick={() => showNotification('History view coming soon!')}>
                          <i className="fas fa-history"></i>
                          <span>View Full History</span>
                        </button>
                        <button className="action-btn" onClick={() => showNotification('Export functionality!')}>
                          <i className="fas fa-file-alt"></i>
                          <span>Generate Report</span>
                        </button>
                        <button className="action-btn" onClick={() => showNotification('Data management coming soon!')}>
                          <i className="fas fa-cog"></i>
                          <span>Manage Data</span>
                        </button>
                        <button className="action-btn" onClick={() => window.open('/index.html', '_blank')}>
                          <i className="fas fa-external-link-alt"></i>
                          <span>View Original Dashboard</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
            </main>
          </div>
        );
      };

      ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
  </body>
</html>
